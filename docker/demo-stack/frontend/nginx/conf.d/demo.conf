# demo frontend (HTTP)
# URL style:
#   http://host:${FRONTEND_PORT}/demo/storer/
# Auto-redirects to include ebus/rest query params:
#   /demo/storer/?ebus=ws://host:12004&rest=http://host:12001

map $app $mq_ws_port {
  default 12004;
  storer 12004;
  retriever 12104;
  temple 13004;
}

map $app $rest_port {
  default 12001;
  storer 12001;
  retriever 12101;
  temple 13001;
}

server {
  listen 80;
  server_name _;

  # /demo/storer -> /demo/storer/
  location ~ ^/demo/(?<app>[^/]+)$ {
    return 302 /demo/$app/;
  }

  # Root of each app: if query missing, redirect to include endpoints.
  # Note: we still serve the static GUI (index.html) on /demo/<app>/.
  location ~ ^/demo/(?<app>[^/]+)/$ {
    if ($arg_ebus = "") {
      return 302 /demo/$app/?ebus=ws://$host:$mq_ws_port&rest=http://$host:$rest_port;
    }
    if ($arg_rest = "") {
      return 302 /demo/$app/?ebus=ws://$host:$mq_ws_port&rest=http://$host:$rest_port;
    }

    root /usr/share/nginx/html;
    try_files /demo/$app/index.html =404;
  }

  # Static assets
  location ^~ /demo/ {
    root /usr/share/nginx/html;
    try_files $uri $uri/ =404;
  }
}
