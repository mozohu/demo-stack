# demo frontend (HTTP)
# URL style:
#   http://host:${FRONTEND_PORT}/demo/storer/
# Auto-redirects to include ebus/rest query params:
#   /demo/storer/?ebus=ws://host:12004&rest=http://host:12001

include /etc/nginx/conf.d/apps.map.conf;

server {
  listen 80;
  server_name _;

  # /demo/storer -> /demo/storer/
  location ~ ^/demo/(?<app>[^/]+)$ {
    # $http_host contains host:port as sent by client
    return 302 http://$http_host/demo/$app/;
  }

  # Root of each app: if query missing, redirect to include endpoints.
  # Note: we still serve the static GUI (index.html) on /demo/<app>/.
  location ~ ^/demo/(?<app>[^/]+)/$ {
    if ($arg_ebus = "") {
      # Use $http_host to preserve :PORT in redirects (e.g., :8088)
      return 302 http://$http_host/demo/$app/?ebus=ws://$host:$mq_ws_port&rest=http://$host:$rest_port;
    }
    if ($arg_rest = "") {
      return 302 http://$http_host/demo/$app/?ebus=ws://$host:$mq_ws_port&rest=http://$host:$rest_port;
    }

    root /usr/share/nginx/html;
    try_files /demo/$app/index.html =404;
  }

  # /media -> /media/
  location = /media {
    return 302 /media/;
  }

  # Some GUIs are hard-coded to fetch /media/... from the same origin.
  # We proxy /media/ to the corresponding instance REST gateway based on Referer:
  #   Referer: http://host:8088/demo/<app>/...
  # Then proxy to:
  #   http://<app>/media/...   (via meshnet, <app> is the instance name)
  location ^~ /media/ {
    set $ref_app "";
    if ($http_referer ~* "/demo/([^/]+)/") {
      set $ref_app $1;
    }

    # If we can't infer app, return 404 instead of proxying to random target.
    if ($ref_app = "") {
      return 404;
    }

    resolver 127.0.0.11 ipv6=off;
    proxy_http_version 1.1;
    proxy_set_header Host $host;

    proxy_pass http://$ref_app$request_uri;
  }

  # Static assets
  location /demo/ {
    root /usr/share/nginx/html;
    try_files $uri $uri/ =404;
  }
}
