# demo frontend (HTTP)
# URL style:
#   http://host:${FRONTEND_PORT}/demo/storer/
# Auto-redirects to include ebus/rest query params:
#   /demo/storer/?ebus=ws://host:12004&rest=http://host:12001

include /etc/nginx/conf.d/apps.map.conf;

server {
  listen 80;
  server_name _;

  # /demo/storer -> /demo/storer/
  location ~ ^/demo/(?<app>[^/]+)$ {
    # $http_host contains host:port as sent by client
    return 302 http://$http_host/demo/$app/;
  }

  # Root of each app: if query missing, redirect to include endpoints.
  # Note: we still serve the static GUI (index.html) on /demo/<app>/.
  location ~ ^/demo/(?<app>[^/]+)/$ {
    if ($arg_ebus = "") {
      # Use $http_host to preserve :PORT in redirects (e.g., :8088)
      return 302 http://$http_host/demo/$app/?ebus=ws://$host:$mq_ws_port&rest=http://$host:$rest_port;
    }
    if ($arg_rest = "") {
      return 302 http://$http_host/demo/$app/?ebus=ws://$host:$mq_ws_port&rest=http://$host:$rest_port;
    }

    root /usr/share/nginx/html;
    try_files /demo/$app/index.html =404;
  }

  # Static assets
  location /demo/ {
    root /usr/share/nginx/html;
    try_files $uri $uri/ =404;
  }
}
