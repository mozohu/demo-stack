(function(){"use strict";var e={509:function(e,t,n){e.exports=n.p+"media/greet.cf6a5a14.mp3"},1352:function(e,t,n){e.exports=n.p+"media/error.6f838fe3.mp3"},6299:function(e,t,n){var s=n(1469),o=n(4055),i=n(7959),l=n.p+"img/pp1.070ee976.png",a=n.p+"img/pp2.b97cadae.png",r=n.p+"img/pp3.cd96cbd2.png",c=n.p+"img/pp4.bd2f9de7.png";const u={class:"ebus-status"},d={class:"page",id:"p1"},h={class:"page",id:"p2"},p={class:"page",id:"p3"},g={class:"page",id:"p4"},m=["src"],f=["onMousedown"];function b(e,t,n,b,v,y){const w=(0,o.g2)("Modal"),k=(0,o.g2)("EbusListener"),E=(0,o.g2)("AudioController");return(0,o.uX)(),(0,o.CE)(o.FK,null,[(0,o.bo)((0,o.Lk)("div",u,[(0,o.Lk)("span",null,"Ebus: "+(0,i.v_)(v.ebusConnected?"ðŸŸ¢":"ðŸ”´"),1)],512),[[s.aG,e.dev]]),(0,o.bo)((0,o.Lk)("div",d,[t[9]||(t[9]=(0,o.Lk)("img",{src:l},null,-1)),(0,o.Lk)("button",{class:"i-btn",id:"p1-go",onMousedown:t[0]||(t[0]=e=>{v.currentPage=2,y.playSound("greet")})},null,32)],512),[[s.aG,1===v.currentPage]]),(0,o.bo)((0,o.Lk)("div",h,[t[10]||(t[10]=(0,o.Lk)("img",{src:a},null,-1)),(0,o.Lk)("button",{class:"i-btn",id:"p2-take-out",onMousedown:t[1]||(t[1]=e=>{v.currentPage=3,y.playSound("scan")})},null,32),(0,o.Lk)("button",{class:"i-btn",id:"p2-deliver",onMousedown:t[2]||(t[2]=e=>{v.currentPage=4,y.playSound("keysign"),v.signature=null})},null,32)],512),[[s.aG,2===v.currentPage]]),(0,o.bo)((0,o.Lk)("div",p,[t[11]||(t[11]=(0,o.Lk)("img",{src:r},null,-1)),(0,o.Lk)("button",{class:"i-btn",id:"p3-home",onMousedown:t[3]||(t[3]=e=>{y.goHome(),y.stopSound()})},null,32)],512),[[s.aG,3===v.currentPage]]),(0,o.bo)((0,o.Lk)("div",g,[t[12]||(t[12]=(0,o.Lk)("img",{src:c},null,-1)),(0,o.Lk)("button",{class:"i-btn",id:"p4-home",onMousedown:t[4]||(t[4]=e=>{y.goHome(),y.stopSound()})},null,32),(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=e=>v.inputValue=e),class:"i-btn",id:"p4-input"},null,512),[[s.Jo,v.inputValue]]),(0,o.Lk)("button",{class:"i-btn",id:"p4-sign",onMousedown:t[6]||(t[6]=(...e)=>y.sign&&y.sign(...e))},[v.signature?((0,o.uX)(),(0,o.CE)("img",{key:0,src:v.signature,style:{"max-height":"7.8vh"}},null,8,m)):(0,o.Q3)("",!0)],32),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(y.computedBtns,((e,t)=>((0,o.uX)(),(0,o.CE)("button",{key:t,class:"i-btn",onMousedown:t=>y.onBtnClick(e[4]),style:(0,i.Tr)({top:e[0]+"vh",left:e[1]+"vw",width:e[2]+"vw",height:e[3]+"vh"})},null,44,f)))),128))],512),[[s.aG,4===v.currentPage]]),(0,o.bF)(w),(0,o.bF)(k,{modelValue:v.ebusConnected,"onUpdate:modelValue":t[7]||(t[7]=e=>v.ebusConnected=e),onEbusEventDispenseEnterEND:y.dispenseEnterEND,onEbusEventAuthAfterAuthFailed:y.authAfterAuthFailed,onEbusEventAuthAfterAuthRequest:y.authAfterAuthRequest,onEbusEventSessEnterIDLE:y.sessEnterIDLE,onEbusEventSessEnterSESSION:t[8]||(t[8]=e=>v.idle=!1),onEbusEvent:y.messageHandler},null,8,["modelValue","onEbusEventDispenseEnterEND","onEbusEventAuthAfterAuthFailed","onEbusEventAuthAfterAuthRequest","onEbusEventSessEnterIDLE","onEbusEvent"]),(0,o.bF)(E,{ref:"audioCtrl",files:v.audiofiles,overlay:0},null,8,["files"])],64)}const v={key:0,class:"modal-content"},y={key:4,class:"sign-buttons"};function w(e,t,n,l,a,r){return(0,o.uX)(),(0,o.CE)("div",null,[a.visible?((0,o.uX)(),(0,o.CE)("div",{key:0,class:"modal-overlay",onMousedown:t[0]||(t[0]=(...e)=>r.handleOverlayClick&&r.handleOverlayClick(...e))},null,32)):(0,o.Q3)("",!0),a.visible?((0,o.uX)(),(0,o.CE)("div",{key:1,class:(0,i.C4)(["modal",{"sign-mode":"sign"===a.mode}]),onMousedown:t[13]||(t[13]=(...e)=>r.handleOverlayClick&&r.handleOverlayClick(...e))},[(0,o.bo)((0,o.Lk)("div",null,[(0,o.Lk)("canvas",{ref:"canvas",width:"500",height:"300",style:{background:"#eeeeee"},onMousedown:t[1]||(t[1]=(...e)=>r.start&&r.start(...e)),onMousemove:t[2]||(t[2]=(...e)=>r.draw&&r.draw(...e)),onMouseup:t[3]||(t[3]=(...e)=>r.stop&&r.stop(...e)),onMouseleave:t[4]||(t[4]=(...e)=>r.stop&&r.stop(...e)),onTouchstart:t[5]||(t[5]=(0,s.D$)(((...e)=>r.start&&r.start(...e)),["prevent"])),onTouchmove:t[6]||(t[6]=(0,s.D$)(((...e)=>r.draw&&r.draw(...e)),["prevent"])),onTouchend:t[7]||(t[7]=(0,s.D$)(((...e)=>r.stop&&r.stop(...e)),["prevent"]))},null,544)],512),[[s.aG,"sign"===a.mode]]),"sign"!==a.mode?((0,o.uX)(),(0,o.CE)("div",v,(0,i.v_)(a.message),1)):(0,o.Q3)("",!0),"info"===a.mode?((0,o.uX)(),(0,o.CE)("button",{key:1,class:"close-btn",onMousedown:t[8]||(t[8]=(...e)=>r.close&&r.close(...e))},"é—œé–‰",32)):(0,o.Q3)("",!0),"yesno"===a.mode?((0,o.uX)(),(0,o.CE)("button",{key:2,class:"yes-btn",onMousedown:t[9]||(t[9]=(...e)=>r.yes&&r.yes(...e))},"æ˜¯",32)):(0,o.Q3)("",!0),"yesno"===a.mode?((0,o.uX)(),(0,o.CE)("button",{key:3,class:"no-btn",onMousedown:t[10]||(t[10]=(...e)=>r.no&&r.no(...e))},"å¦",32)):(0,o.Q3)("",!0),"sign"===a.mode?((0,o.uX)(),(0,o.CE)("div",y,[(0,o.Lk)("button",{onClick:t[11]||(t[11]=(...e)=>r.clearCanvas&&r.clearCanvas(...e))},"æ¸…é™¤"),(0,o.Lk)("button",{onClick:t[12]||(t[12]=(...e)=>r.confirmSign&&r.confirmSign(...e))},"ç¢ºå®š")])):(0,o.Q3)("",!0)],34)):(0,o.Q3)("",!0)])}var k=n(9762);const E=(0,k.A)();E.once=function(e,t){const n=()=>{t(),E.off(e,n)};return E.on(e,n),E};const C={showLocked(e="è™•ç†ä¸­ï¼Œè«‹ç¨å€™â€¦"){return E.emit("showLocked",e),E},showInfo({message:e="",delay:t=3e3,callback:n=null}={}){return E.emit("showInfo",{message:e,delay:t}),"function"===typeof n&&E.once("modalClosed",n),E},showYesNo(e="å†æ¬¡ç¢ºèªâ€¦",t,n){return E.emit("showYesNo",{message:e,yes:t,no:n}),E},showSign(e){return E.emit("showSign",e),E},close(){return E.emit("modalClosed"),E}};var S={data(){return{timer:null,visible:!1,message:"",mode:"info",delay:8e3,yesCallback:null,noCallback:null,signCallback:null,ctx:null,isDrawing:!1}},methods:{showInfo(e="",t=8e3){this.mode="info",this.message=e,this.visible=!0,this.delay=t,this.timer=setTimeout((()=>{this.close()}),t)},showLocked(e=""){this.mode="locked",this._clearTimer(),this.message=e,this.visible=!0},showYesNo(e,t,n){this.mode="yesno",this.message=e,this.yesCallback=t,this.noCallback=n,this.visible=!0},showSign(e){this.mode="sign",this.visible=!0,this.signCallback=e,this.$nextTick((()=>{this.initCanvas()}))},initCanvas(){const e=this.$refs.canvas;if(!e)return;const t=e.parentElement,n=t.clientWidth-20,s=Math.min(n,500),o=Math.floor(.6*s);e.width=s,e.height=o,e.style.width=s+"px",e.style.height=o+"px",this.ctx=e.getContext("2d"),this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.strokeStyle="#000"},yes(){"function"===typeof this.yesCallback&&this.yesCallback(),this.visible=!1},no(){"function"===typeof this.noCallback&&this.noCallback(),this.visible=!1},close(){this._clearTimer(),this.visible=!1,E.emit("modalClosed")},handleOverlayClick(){"info"===this.mode&&this.close()},_clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=null)},getPos(e){const t=this.$refs.canvas.getBoundingClientRect();return e.touches?{x:e.touches[0].clientX-t.left,y:e.touches[0].clientY-t.top}:{x:e.clientX-t.left,y:e.clientY-t.top}},start(e){const t=this.getPos(e);this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.isDrawing=!0},draw(e){if(!this.isDrawing)return;const t=this.getPos(e);this.ctx.lineTo(t.x,t.y),this.ctx.stroke()},stop(){this.isDrawing=!1,this.ctx.closePath()},clearCanvas(){const e=this.$refs.canvas;this.ctx.clearRect(0,0,e.width,e.height)},confirmSign(){const e=this.$refs.canvas,t=e.width,n=e.height,s=this.ctx.getImageData(0,0,t,n),o=s.data;let i=null,l=null,a=null,r=null;for(let f=0;f<n;f++)for(let e=0;e<t;e++){const n=4*(f*t+e);o[n+3]>0&&((null===i||f<i)&&(i=f),(null===l||f>l)&&(l=f),(null===a||e<a)&&(a=e),(null===r||e>r)&&(r=e))}if(null===i)return;const c=10;i=Math.max(0,i-c),l=Math.min(n-1,l+c),a=Math.max(0,a-c),r=Math.min(t-1,r+c);const u=r-a+1,d=l-i+1,h=this.ctx.getImageData(a,i,u,d),p=document.createElement("canvas");p.width=u,p.height=d;const g=p.getContext("2d");g.fillStyle="white",g.fillRect(0,0,u,d),g.putImageData(h,0,0);const m=p.toDataURL("image/png");"function"===typeof this.signCallback&&this.signCallback(m),this.close()}},created(){E.on("showLocked",this.showLocked),E.on("showInfo",(e=>{this.showInfo(e.message,e.delay)})),E.on("showYesNo",(e=>{this.showYesNo(e.message,e.yes,e.no)})),E.on("showSign",this.showSign)},mounted(){this.$refs.canvas&&this.initCanvas()}},L=n(5932);const x=(0,L.A)(S,[["render",w],["__scopeId","data-v-fb76a4b6"]]);var A=x,I={data(){return{dev:!1}},created(){const e=new URLSearchParams(window.location.search);e.has("dev")&&(this.dev=!0,document.body.classList.add("dev-mode"))},mounted(){document.addEventListener("contextmenu",(e=>e.preventDefault())),document.addEventListener("dragstart",(function(e){e.preventDefault()}))}};function T(e,t,n,s,o,i){return null}n(4114),n(8111),n(7588);var M=n(4229);class D{constructor(){this.client=null,this.listeners=[],this.connected=!1}connect(e=null){if(this.client)return;const t={connectTimeout:4e3,clientId:"vue-ebus-"+Math.random().toString(16).substring(2,8)},n=`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.hostname}:9001/mqtt`,s=e||n;console.log(`[EbusService] Connecting to ${s}`),this.client=M.A.connect(s,t),this.client.on("connect",(()=>{this.connected=!0,this.client.subscribe("topic/app",(e=>{e||console.log("[EbusService] Subscribed topic/app")}))})),this.client.on("message",((e,t)=>{try{const e=JSON.parse(t.toString());e&&e.e&&this.notifyAll(e)}catch(n){console.error("MQTT parse error:",t.toString())}})),this.client.on("error",(e=>{console.error("[EbusService] Error:",e)})),this.client.on("close",(()=>{this.connected=!1}))}onEvent(e){"function"===typeof e&&this.listeners.push(e)}notifyAll(e){this.listeners.forEach((t=>t(e)))}send(e,t){if(this.client&&this.connected){const n="queue/app",s={e:e};t&&(s.arg=t);const o=JSON.stringify(s);this.client.publish(n,o),console.log(`[EbusService] ç™¼é€è‡³ ${n}ï¼š`,o)}else console.warn("[EbusService] ç„¡æ³•ç™¼é€ï¼šå°šæœªé€£ç·š")}}var O=new D,$={name:"EbusListener",props:{modelValue:{type:Boolean,default:!1},ebusUrl:{type:String,required:!1}},mounted(){const e=new URLSearchParams(window.location.search),t=e.get("ebus"),n=t||this.ebusUrl||null;O.connect(n);const s=e=>{this.$emit("update:modelValue",e)};O.onEvent((e=>{if(this.$emit("ebus-event",e),e.e){const t=e.e.replace(/[\/_]/g,"-");this.$emit(`ebus-event-${t}`,e)}})),O.client&&(O.client.on("close",(()=>s(!1))),O.client.on("connect",(()=>s(!0))))}};const _=(0,L.A)($,[["render",T]]);var P=_,G={name:"AudioController",props:{files:{type:Object,required:!0},overlay:{type:Number,default:0}},data(){return{players:{}}},methods:{play(e){const t=this.files[e];if(!t)return;0===this.overlay&&this.stopAll();const n=new Audio(t);n.play(),this.players[e]=n,this.$emit("onPlay",e),n.addEventListener("ended",(()=>{delete this.players[e],this.$emit("onStop",e)}))},stop(e){const t=this.players[e];t&&(t.pause(),t.currentTime=0,delete this.players[e],this.$emit("onStop",e))},stopAll(){Object.keys(this.players).forEach((e=>this.stop(e)))}}};const U=G;var N=U,V={name:"App",mixins:[I],components:{Modal:A,EbusListener:P,AudioController:N},methods:{onBtnClick(e){if("BS"===e)this.inputValue=this.inputValue.slice(0,-1);else if("CL"===e)this.inputValue="";else if("OK"===e){if(!this.inputValue)return;this.handleSubmit(this.inputValue,this.signature,"keypad")}else this.inputValue+=e},sign(){C.showSign((e=>{this.signature=e}))},goHome(){this.currentPage=1,this.inputValue="",O.send("reader/start")},messageHandler(e){if(this.dev&&console.log(e),e&&e.arg&&void 0!==e.arg.msg&&e.e.includes("after_")){let t=null;"failed"===e.on&&(t=()=>{this.inputValue="",this.signature=null}),C.showInfo({message:e.arg.msg,callback:t})}},authAfterAuthFailed(){this.playSound("errorcode")},authAfterAuthRequest(){C.showLocked()},dispenseEnterEND(e){"prod_dispensed"===e.on&&("keypad"!==e.arg.type&&this.playSound("bye"),this.goHome()),O.send("reader/start")},sessEnterIDLE(){this.idle=!0,this.goHome()},handleSubmit(e,t,n){O.send("reader/read",{type:n,data:e,signature:t})},refreshSession(){this.idle?(O.send("sess/session_begin"),this.idle=!1):O.send("sess/refresh_timer")},playSound(e){this.$refs.audioCtrl.play(e)},stopSound(){this.$refs.audioCtrl.stopAll()}},data(){return{keypadConfig:{ktop:71.9,kleft:6.9,bspan:8.8,rspan:5.7,bw:7.2,bh:4.2,bclw:11.1,bokw:13,bclspan:12.3},ebusConnected:!1,signature:null,inputValue:"",currentPage:1,idle:!0,audiofiles:{greet:n(509),scan:n(8381),keysign:n(8468),errorcode:n(1352),bye:n(7114)}}},computed:{computedBtns(){const{ktop:e,kleft:t,bspan:n,rspan:s,bw:o,bh:i,bclw:l,bokw:a,bclspan:r}=this.keypadConfig;return[[e+0*s,t+0*n,o,i,"1"],[e+0*s,t+1*n,o,i,"2"],[e+0*s,t+2*n,o,i,"3"],[e+0*s,t+3*n,o,i,"4"],[e+0*s,t+4*n,o,i,"5"],[e+0*s,t+5*n,o,i,"6"],[e+0*s,t+6*n,o,i,"7"],[e+0*s,t+7*n,o,i,"8"],[e+0*s,t+8*n,o,i,"9"],[e+0*s,t+9*n,o,i,"0"],[e+1*s,t+0*n,o,i,"Q"],[e+1*s,t+1*n,o,i,"W"],[e+1*s,t+2*n,o,i,"E"],[e+1*s,t+3*n,o,i,"R"],[e+1*s,t+4*n,o,i,"T"],[e+1*s,t+5*n,o,i,"Y"],[e+1*s,t+6*n,o,i,"U"],[e+1*s,t+7*n,o,i,"I"],[e+1*s,t+8*n,o,i,"O"],[e+1*s,t+9*n,o,i,"P"],[e+2*s,t+0*n,o,i,"A"],[e+2*s,t+1*n,o,i,"S"],[e+2*s,t+2*n,o,i,"D"],[e+2*s,t+3*n,o,i,"F"],[e+2*s,t+4*n,o,i,"G"],[e+2*s,t+5*n,o,i,"H"],[e+2*s,t+6*n,o,i,"J"],[e+2*s,t+7*n,o,i,"K"],[e+2*s,t+8*n,o,i,"L"],[e+2*s,t+9*n,o,i,"BS"],[e+3*s,t+0*n,o,i,"Z"],[e+3*s,t+1*n,o,i,"X"],[e+3*s,t+2*n,o,i,"C"],[e+3*s,t+3*n,o,i,"V"],[e+3*s,t+4*n,o,i,"B"],[e+3*s,t+5*n,o,i,"N"],[e+3*s,t+6*n,o,i,"M"],[e+3*s,t+7*n,l,i,"CL"],[e+3*s,t+7*n+r,a,i,"OK"]]}},mounted(){this.$nextTick((()=>{!this.ebusConnected&&O.connected&&(this.ebusConnected=!0)})),document.addEventListener("mousedown",this.refreshSession),document.addEventListener("touchstart",(function(e){e.touches.length>1&&e.preventDefault()}),{passive:!1});const e=new URLSearchParams(window.location.search),t=e.get("css");if(t){const e=document.createElement("link");e.rel="stylesheet",e.href=t,e.onload=()=>console.log("[GUI] external CSS loaded:",t),e.onerror=()=>console.error("[GUI] failed to load CSS:",t),document.head.appendChild(e)}const n=e.get("settings");if(n){console.log("[GUI] loading external settings:",n);const e=document.createElement("script"),t=Date.now();e.src=`${n}?v=${t}`,e.async=!0,e.onload=()=>{console.log("[GUI] script onload triggered âœ…"),console.log(window.GUI_SETTINGS),window.GUI_SETTINGS&&window.GUI_SETTINGS.keypadConfig&&(console.log("[GUI] settings loaded:",window.GUI_SETTINGS),Object.assign(this.keypadConfig,window.GUI_SETTINGS.keypadConfig))},document.head.appendChild(e)}},watch:{ebusConnected(e){e&&O.send("reader/start")}}};const X=(0,L.A)(V,[["render",b]]);var R=X;if("true"==={NODE_ENV:"production",BASE_URL:""}.VUE_APP_IS_DEV_BUILD){const e=document.createElement("style");e.innerHTML=".i-btn { border: 1px solid red !important; }",document.head.appendChild(e)}(0,s.Ef)(R).mount("#app")},7114:function(e,t,n){e.exports=n.p+"media/bye.6dc9a619.mp3"},8381:function(e,t,n){e.exports=n.p+"media/scan.b6524f08.mp3"},8468:function(e,t,n){e.exports=n.p+"media/keysign.0905d956.mp3"}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,n),i.exports}n.m=e,function(){n.amdO={}}(),function(){var e=[];n.O=function(t,s,o,i){if(!s){var l=1/0;for(u=0;u<e.length;u++){s=e[u][0],o=e[u][1],i=e[u][2];for(var a=!0,r=0;r<s.length;r++)(!1&i||l>=i)&&Object.keys(n.O).every((function(e){return n.O[e](s[r])}))?s.splice(r--,1):(a=!1,i<l&&(l=i));if(a){e.splice(u--,1);var c=o();void 0!==c&&(t=c)}}return t}i=i||0;for(var u=e.length;u>0&&e[u-1][2]>i;u--)e[u]=e[u-1];e[u]=[s,o,i]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){n.p=""}(),function(){var e={524:0};n.O.j=function(t){return 0===e[t]};var t=function(t,s){var o,i,l=s[0],a=s[1],r=s[2],c=0;if(l.some((function(t){return 0!==e[t]}))){for(o in a)n.o(a,o)&&(n.m[o]=a[o]);if(r)var u=r(n)}for(t&&t(s);c<l.length;c++)i=l[c],n.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return n.O(u)},s=self["webpackChunkretriever"]=self["webpackChunkretriever"]||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))}();var s=n.O(void 0,[504],(function(){return n(6299)}));s=n.O(s)})();